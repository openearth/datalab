# vim: ft=nginx

# Apache for /repos /lam
upstream apache {
    server 127.0.0.1:9080;
}

# Tomcat for /thredds /pgstudio /geoserver /geoexplorer /geonetwork
upstream tomcat {
    server 127.0.0.1:8080;
}

server {
    listen       443 ssl;
    server_name  localhost default;

    ssl_certificate      /etc/nginx/{{ansible_fqdn}}.nginx.pem;
    ssl_certificate_key  /etc/nginx/{{ansible_fqdn}}.nginx.key;

    ssl_session_cache shared:SSL:1m;
    ssl_session_timeout  5m;

    ssl_protocols TLSv1 TLSv1.1 TLSv1.2;
    ssl_ciphers  HIGH:!aNULL:!MD5;
    ssl_prefer_server_ciphers   on;
    add_header Front-End-Https on;

#########################
# Django
#########################
    location / {
        #root   /usr/share/nginx/html;
        #index  index.html index.htm;

        root /srv/{{ app }}/src/;
        include uwsgi_params;
        uwsgi_pass uwsgi_{{ app }};
    }

    location = /auth/ {
        uwsgi_param PATH_INFO /auth/;
        uwsgi_param REQUEST_URI /auth/;
        uwsgi_param REQUEST_METHOD GET;
        uwsgi_pass uwsgi_{{ app }};
    }


    location /ws/ {
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_pass http://uwsgi_{{ app }}_websocket;
    }

    location /media/docs/ {
        root /srv/{{ app }};
        access_log  /var/log/nginx/access_docs.log;
        try_files $uri $uri/ =404;
    }

    location /media/ {
        root /data/{{ app }};
        access_log     off;
        try_files $uri $uri/ =404;
        expires 7d;
    }



    location /static/ {
        root /srv/{{ app }};
        access_log     off;
        try_files $uri $uri/ =404;
        expires 7d;
    }

    location /secure_downloads/ {
        internal;
        alias /srv/{{ app }}/smedia/files/;
    }

    location /secure_download_thumbnails/ {
        internal;
        alias /srv/{{ app }}/smedia/files/files_thumbnails/;
    }

    location ~ /\.(svn|git|hg)  {
        # Prevent hidden files inside repositories from being served
        deny all;
    }

#########################
# KML Server via Django
#########################

    location /secure_kml/ {
        internal;
        alias /data/kml/;
    }

#########################
# SVN
#########################
    location /repos/ {
        include auth_request.conf;
        set $fixed_destination $http_destination;
        if ( $http_destination ~* ^https(.*)$ )
        {
            set $fixed_destination http$1;
        }

        client_max_body_size    0;
        keepalive_timeout       3600;
        send_timeout            1200; # remove?
        keepalive_requests      300; # Does 0 work?
        proxy_set_header        X-Real-IP $remote_addr;
        proxy_set_header        X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header        Host $host;
        proxy_set_header        Destination $fixed_destination;
        # Kind of weird; but I accidently discovers this fixes issues with
        # svn cp.
        rewrite                 /repos/(.*)     /repos/$1    break;
        proxy_pass              http://apache/repos/;
    }
#########################
# Thredds
#########################
    location /thredds/ {
        include auth_request.conf;
        proxy_redirect off;
        # For development
        #proxy_redirect http://localhost/thredds/    https://localhost:8443/thredds/;
        # For production/accept/test
        #proxy_redirect http://$host:443/thredds/    https://$host:443/thredds/;
        proxy_set_header   Host             $host:$server_port;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-Proto https; # For tomcat
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_pass         http://tomcat/thredds/;

    }

#########################
# Ldap Aaccount Manager
#########################
    location /lam/ {
        # For development
        proxy_pass         http://apache/lam/;
        proxy_set_header   Host $http_host;
        proxy_redirect    off;
        proxy_set_header  Host               $host:443;
        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-Proto  https;
    }

#########################
# PostgreSQL Studio
#########################
    location /pgstudio/ {
        proxy_pass        http://tomcat/pgstudio/;
        proxy_redirect    off;
        proxy_set_header  Host               $host:443;
        proxy_set_header  X-Real-IP          $remote_addr;
        #proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto  https;

    }

#########################
# Geosuite
#########################
    location /geoserver/ {
        include auth_request.conf;
        proxy_pass        http://tomcat/geoserver/;
        proxy_redirect    off;
        proxy_set_header  Host               $host:443;
        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-Proto  https;
    }

    location /geoexplorer/ {
        include auth_request.conf;
        proxy_pass        http://tomcat/geoexplorer/;
        proxy_redirect    off;
        proxy_set_header  Host               $host:443;
        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-Proto  https;
    }

#########################
# Geonetwork
#########################
    location /geonetwork/ {
        include auth_request.conf;
        proxy_pass        http://tomcat/geonetwork/;
        proxy_redirect    off;
        proxy_set_header  Host               $host:443;
        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-Proto  https;
    }
}
